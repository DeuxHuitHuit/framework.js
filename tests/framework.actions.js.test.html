<!DOCTYPE html public "âœ°">
<html lang="en">

<head>
	<meta charset="utf-8" />
	<title>app-actions.js test suite</title>

	<link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-1.23.1.css" type="text/css" />

	<style type="text/css">
	</style>

	<script>
		(function (w, doc, co) {
			// https://stackoverflow.com/questions/901115/get-query-string-values-in-javascript
			var u = {},
				e, t,
				a = /\+/g,  // Regex for replacing addition symbol with a space
				r = /([^&=]+)=?([^&]*)/g,
				d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
				q = w.location.search.substring(1),
				v = '2.2.4';

			while (e = r.exec(q)) {
				u[d(e[1])] = d(e[2]);
			}

			if (!!u.jquery) {
				v = u.jquery;
			}
			if (v === 'local') {
				t = './jquery.js';
			} else {
				t = 'https://ajax.googleapis.com/ajax/libs/jquery/' + v + '/jquery.js'
			}
			doc.write('<script src="' + t + '">' + '<' + '/' + 'script>');
			co.log('\nLoading jQuery v' + v + '\n');
		})(window, document, console);
	</script>
</head>

<body>
	<h1 id="qunit-header">app-actions.js</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>

	<script src="https://code.jquery.com/qunit/qunit-1.23.1.js"></script>
	<script src="../src/app-log.js"></script>
	<script src="../src/app-callback.js"></script>
	<script src="../src/app-actions.js"></script>
	<script src="../src/app-debug.js"></script>

	<script>
		(function ($, w) {
			"use strict";

				module('App.actions');
				App.debug(true);

				test('Test resolve', function AppActionsResolve() {
					var actions = {
						test: $.noop,
						site: {
							test: {
								test: {
									test: $.noop
								}
							}
						}
					};
					ok(!App.actions.resolve(actions, 'x'), 'x does not resolve');
					ok($.noop === App.actions.resolve(actions, 'test'), 'test resolves');
					ok(!App.actions.resolve(actions, 'site'), 'site does not resolve');
					ok($.noop === App.actions.resolve(actions, 'site.test.test.test'), 'site.test.test.test resolves');
				});

				test('Test execute', function AppActionsExecute() {
					var counter = 0;
					var fx = function (key, data) {
						ok(true, 'fx was called');
						ok(key === 'test4', 'key is test4');
						ok(!data, 'data is false-y');
						return true;
					};
					var cb = function (key, data) {
						ok(key === 0, 'key is 0');
						ok(data, 'ok is true-y');
						counter++;
					};
					App.actions.execute(fx, 'test4', null, cb);
					ok(counter === 1, 'cb was called exactly once');
				});

				test('Test execute with stack', function AppActionsExecute() {
					var counter = 0;
					var fx = function (key, data) {
						ok(true, 'fx read was called');
						return function () {
							ok(true, 'fx write was called');
							ok(key === 'test4', 'key is test4');
							ok(!data, 'data is false-y');
							counter++;
						};
					};
					App.actions.execute(fx, 'test4');
					ok(counter === 1, 'write was called exactly once');
					counter = 0;
					fx = function (key, data) {
						return {
							read: function () {
								ok(true, 'fx read was called');
								counter++;
							},
							write: function () {
								ok(true, 'fx write was called');
								counter++;
							}
						}
					};
					App.actions.execute(fx, 'test');
					ok(counter === 2, 'read and write was called exactly once');
				});
				
				test('Test execute with dynamic stack', function AppActionsExecute() {
					var counter = 0, innerCounter = 0;
					var inner = function (key, data) {
						return {
							read: function () {
								ok(App.actions.stack().length > 0, 'read: stack is not empty');
								innerCounter++;
							},
							write: function () {
								ok(App.actions.stack().length > 0, 'write: stack is not empty');
								innerCounter++;
							}
						}
					};
					var fx = function (key, data) {
						counter++;
						App.actions.execute(inner, 'inner');
						return function () {
							counter++;
						};
					};
					App.actions.execute([fx, fx, fx], 'test');
					ok(counter === 6, 'read and write was called exactly three times each');
					ok(innerCounter === 6, 'inner read and write was called exactly three times each');
				});


		})(jQuery, window);
	</script>
</body>

</html>