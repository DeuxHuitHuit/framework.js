<!DOCTYPE html public "âœ°">
<html lang="en">
<head> 
	<meta charset="utf-8" /> 
	<title>framework.js test suite</title> 
	
	<link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.9.2.css" integrity="sha256-toepOe5D+ddXgUOGsijnhymZna5bakJ0gwRC/3bK1b0=" crossorigin="anonymous" />
	
	<style type="text/css">

	</style>
	
	<script>
		(function (w, doc,co) {
			// https://stackoverflow.com/questions/901115/get-query-string-values-in-javascript
			var u = {},
				e, t,
				a = /\+/g,  // Regex for replacing addition symbol with a space
				r = /([^&=]+)=?([^&]*)/g,
				d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
				q = w.location.search.substring(1),
				v = '2.2.4';

			while (e = r.exec(q)) {
				u[d(e[1])] = d(e[2]);
			}

			if (!!u.jquery) {
				v = u.jquery;
			}
			if (v === 'local') {
				t = './jquery.js';
			} else {
				t = 'https://ajax.googleapis.com/ajax/libs/jquery/' + v + '/jquery.js'
			}
			doc.write('<script src="' + t + '">' + '<' + '/' + 'script>');
			co.log('\nLoading jQuery v' + v + '\n');
		})(window, document, console);
	</script>
</head>
<body>
	<h1 id="qunit-header">framework.js: Loader</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
	
	<script src="https://code.jquery.com/qunit/qunit-2.9.2.js" integrity="sha256-EQ5rv6kPFPKQUYY+P4H6fm/le+yFRLVAb//2PfBswfE=" crossorigin="anonymous"></script>
	<script src="../src/globals.js"></script>
	<script src="../src/app-log.js"></script>
	<script src="../src/app-debug.js"></script> 
	<script src="../src/app-callback.js"></script> 
	<script src="../src/app-loader.js"></script>
	
	<script>
		(function ($, w) {
			'use strict';
			QUnit.module('App.loader');
			App.debug(true);
			
			QUnit.test('load 1 - test load a 200 and a 404', function firstTest (assert) {
				var successCount = 0;
				var errorCount = 0;
				var completeCount = 0;
				var giveup = 0;
				var clienterror = 0;

				var next = assert.async();

				App.loader
					.load('framework.js.test.html')
					.load({
						url: '1.html', // 404
						vip: false,
						success: function () {
							successCount++; // should not get called
						},
						error: function () {
							errorCount++;
						},
						giveup: function () {
							giveup++; // should not get called
						},
						clienterror: function () {
							clienterror++;
						},
						complete: function () {
							completeCount++;

							// should be called only once
							if (completeCount === 1) {
								assert.equal(clienterror, 1, '1.html clienterror count is 1');
								assert.equal(giveup, 0, '1.html giveup count is 0');
								assert.equal(successCount, 0, '1.html successCount is 0');
								assert.equal(errorCount, 1, '1.html errorCount is 1');
								next();
							}
						}
					});
			});
			QUnit.test('load 2 - test progress', function second(assert) {
				var progressCount = 0;
				var progressE = null;

				var successCount = 0;
				var errorCount = 0;
				var completeCount = 0;

				var next = assert.async();

				App.loader.load({
					url: '2.html', // valid
					success: function (e) {
						successCount++;
					},
					error: function () {
						errorCount++; // should not get called
					},
					progress: function (e) {
						progressCount++;
						progressE = e;
					},
					complete: function () {
						completeCount++;
						
						// don't let the retries do that
						if (completeCount === 1) {
							assert.equal(successCount, 1, '2.html successCount is 1');
							assert.equal(errorCount, 0, '2.html errorCount is 1');

							assert.ok(progressE, '2.html progressE is true');
							assert.equal(progressCount, 1, '2.html progressCount is 1');
							
							next();
						}
					}
				});
			});
			QUnit.test('load 3 - test response cache', function third(assert) {
				var cacheCount = 0;

				var successCount = 0;
				var errorCount = 0;
				var completeCount = 0;

				var next = assert.async();
				
				// mock Storage
				var _store = {};
				w.App.storage = {
					session: {
						get: function (key) {
							return _store[key];
						},
						set: function (key, value) {
							_store[key] = value;
							return true;
						},
						remove: function (key) {
							_store[key] = undefined;
							return true;
						}
					}
				};

				App.loader.load({
						url: '2.html', // valid
						cache: true,
						success: function (e) {
							successCount++;
						},
						complete: function () {
							assert.equal(successCount, 1, '2.html cache successCount is 1');
							
							assert.ok(w.App.storage.session.get('2.html'), '2.html cache storage is present');
							assert.equal(w.App.storage.session.get('2.html'), 'test file', '2.html cache is 2.html content');
							
							App.loader.load({
								url: '2.html', // valid
								cache: true,
								cachehit: function () {
									cacheCount++;
								},
								success: function (data) {
									assert.equal(cacheCount, 1, '2.html cache cacheCount is 1');
									assert.equal(data, w.App.storage.session.get('2.html'), '2.html retreived from cache');
									
									delete window.App.storage;
									
									next();
								}
							});
						}
					});
			});
			QUnit.test('load 4 - test isLoading and inQueue', function fourth(assert) {
				var next = assert.async();
				App.loader.load({
					url: '2.html',
					complete: function () {
						next();
					}
				});
				
				assert.ok(App.loader.isLoading('2.html'), '2.html is loading');
				assert.ok(App.loader.isLoading({url: '2.html'}), '{ url: \'2.html\' } is loading');
				assert.equal(App.loader.inQueue('2.html'), -1, '2.html is not in queue');
				
				App.loader.load({
					url: '2.html',
					method: 'POST'
				});
				assert.equal(App.loader.inQueue('2.html'), 0, '2.html is not in queue');
			});
		})(jQuery, window);
	</script>
</body>
</html>