<!DOCTYPE html public "âœ°">
<html lang="en">
<head> 
	<meta charset="utf-8" /> 
	<title>framework.js test suite</title> 
	
	<link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-1.23.1.css" type="text/css" />
	
	<style type="text/css">

	</style>
	
	<script>
		(function (w, doc,co) {
			// https://stackoverflow.com/questions/901115/get-query-string-values-in-javascript
			var u = {},
				e, t,
				a = /\+/g,  // Regex for replacing addition symbol with a space
				r = /([^&=]+)=?([^&]*)/g,
				d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
				q = w.location.search.substring(1),
				v = '2.2.4';

			while (e = r.exec(q)) {
				u[d(e[1])] = d(e[2]);
			}

			if (!!u.jquery) {
				v = u.jquery;
			}
			if (v === 'local') {
				t = './jquery.js';
			} else {
				t = 'https://ajax.googleapis.com/ajax/libs/jquery/' + v + '/jquery.js'
			}
			doc.write('<script src="' + t + '">' + '<' + '/' + 'script>');
			co.log('\nLoading jQuery v' + v + '\n');
		})(window, document, console);
	</script>
</head>
<body>
	<h1 id="qunit-header">framework.js: Loader</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
	
	<script src="https://code.jquery.com/qunit/qunit-1.23.1.js"></script>
	<script src="../src/globals.js"></script>
	<script src="../src/app-log.js"></script>
	<script src="../src/app-debug.js"></script> 
	<script src="../src/app-callback.js"></script> 
	<script src="../src/app-loader.js"></script>
	
	<script>
	(function ($, w) {
		
		'use strict';
		
		var runTests = function  () {
			
			module('App.loader');
			App.debug(true);
			
			test('load', function loaderLoadTest () {
				
				var fisrtTest = function () {
					var successCount = 0;
					var errorCount = 0;
					var completeCount = 0;
					var giveup = 0;

					stop();

					App.loader
						.load('framework.js.test.html')
						.load({
							url: '1.html', // 404
							vip: false,
							success: function () {
								successCount++; // should not get called
							},
							error: function () {
								errorCount++;
							},
							giveup: function () {
								giveup++;
							},
							complete: function () {
								completeCount++;

								// should be called at least 2 times
								if (completeCount > 2) {

									start();
									equal(giveup, 1, '1.html giveup count is 1');
									equal(successCount, 0, '1.html successCount is 0');
									equal(errorCount, 3, '1.html errorCount is 3');

									secondTest();
								}
							}
						});
				};

				var secondTest = function () {
					var progressCount = 0;
					var progressE = null;

					var successCount = 0;
					var errorCount = 0;
					var completeCount = 0;

					stop();

					App.loader.load({
						url: '2.html', // valid
						success: function (e) {
							successCount++;
						},
						error: function () {
							errorCount++; // should not get called
						},
						progress: function (e) {
							progressCount++;
							progressE = e;
						},
						complete: function () {
							completeCount++;
							
							// don't let the retries do that
							if (completeCount === 1) {
								start();
								
								equal(successCount, 1, '2.html successCount is 1');
								equal(errorCount, 0, '2.html errorCount is 1');

								ok(progressE, '2.html progressE is true');
								equal(progressCount, 1, '2.html progressCount is 1');
								
								thirdTest();
							}
						}
					});
				};
				
				var thirdTest = function () {
					var cacheCount = 0;

					var successCount = 0;
					var errorCount = 0;
					var completeCount = 0;

					stop();
					
					// mock Storage
					var _store = {};
					w.App.storage = {
						session: {
							get: function (key) {
								return _store[key];
							},
							set: function (key, value) {
								_store[key] = value;
								return true;
							},
							remove: function (key) {
								_store[key] = undefined;
								return true;
							}
						}
					};

					App.loader.load({
						url: '2.html', // valid
						cache: true,
						success: function (e) {
							successCount++;
						},
						complete: function () {
							start();
							
							equal(successCount, 1, '2.html cache successCount is 1');
							
							ok(w.App.storage.session.get('2.html'), '2.html cache storage is present');
							equal(w.App.storage.session.get('2.html'), 'test file', '2.html cache is 2.html content');
							
							stop();
							
							App.loader.load({
								url: '2.html', // valid
								cache: true,
								cachehit: function () {
									cacheCount++;
								},
								success: function (data) {
									start();
									equal(cacheCount, 1, '2.html cache cacheCount is 1');
									equal(data, w.App.storage.session.get('2.html'), '2.html retreived from cache');
									
									delete window.App.storage;
									
									fourthTest();
								}
							});
						}
					});
				};
				
				var fourthTest = function () {
					App.loader.load({
						url: '2.html',
						complete: function () {
							start();
						}
					});
					
					ok(App.loader.isLoading('2.html'), '2.html is loading');
					ok(App.loader.isLoading({url: '2.html'}), '{ url: \'2.html\' } is loading');
					equal(App.loader.inQueue('2.html'), -1, '2.html is not in queue');
					
					App.loader.load({
						url: '2.html',
						method: 'POST'
					});
					equal(App.loader.inQueue('2.html'), 0, '2.html is not in queue');
					
					stop();
				};
				
				fisrtTest();
			});
			
		}; // end run tests
		
		$(w).load(runTests);
		
	})(jQuery, window);
	</script>
</body>
</html>