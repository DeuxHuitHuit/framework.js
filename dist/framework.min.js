/*! framework.js - v1.0.0 - 2013-01-24
* https://github.com/DeuxHuitHuit/framework.js
* Copyright (c) 2013 Deux Huit Huit; Licensed MIT */
(function(e,t){"use strict";var n=navigator.userAgent;e.unsupported=!e.browser||e.browser.msie&&parseInt(e.browser.version,10)<9,e.iphone=!!n&&(n.match(/iPhone/i)||n.match(/iPod/i)),e.ios=e.iphone||!!n&&n.match(/iPad/i),e.mobile=e.ios||!!n&&(n.match(/Android/i)||n.match(/mobile/i)||n.match(/phone/i))})(jQuery),function(e,t){"use strict";e.mobile&&e("html").addClass("mobile"),e.easing.def=e.mobile?"linear":"easeOutQuad"}(jQuery),function(e,t){"use strict";window.console||(console.log=console.warn=console.error=console.info=console.dir=e.noop)}(jQuery),function(e,t){"use strict";var n=function(e){return("0"+parseInt(e,10).toString(16)).slice(-2)};window.rgb2hex=function(e){var t=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);return t?n(t[1])+n(t[2])+n(t[3]):e},window.pd=function(t){return t&&e.isFunction(t.preventDefault)&&t.preventDefault(),!1},window.keys={"?":0,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause_break:19,caps_lock:20,escape:27,space_bar:32,page_up:33,page_down:34,end:35,home:36,left_arrow:37,up_arrow:38,right_arrow:39,down_arrow:40,insert:45,"delete":46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,left_window_key:91,right_window_key:92,select_key:93,numpad_0:96,numpad_1:97,numpad_2:98,numpad_3:99,"numpad 4":100,numpad_5:101,numpad_6:102,numpad_7:103,numpad_8:104,numpad_9:105,multiply:106,add:107,subtract:109,"decimal point":110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,num_lock:144,scroll_lock:145,semi_colon:186,";":186,"=":187,equal_sign:187,comma:188,",":188,dash:189,".":190,period:190,forward_slash:191,"/":191,grave_accent:192,open_bracket:219,back_slash:220,"\\":220,close_braket:221,single_quote:222},window.keyFromCode=function(t){var n="?";return t?(e.each(window.keys,function(e,r){return t==r?(n=e,!1):!0}),n):n}}(jQuery),function(e,t){"use strict";var n=[],r=!1,i=null,s=function(e){return!!i&&i===e},o=function(t){var r=-1;return e.each(n,function(n,i){return i.url===t?(r=n,!1):!0}),r},u=function(){n.length?a():r=!1},a=function(){var t=n.shift(),r=e.extend({},t,{success:function(){i=null,u(),App.callback.call(this,t.success,arguments)},error:function(){i=null,App.log({args:["Error loading url %s",t.url],me:"Loader"}),t.vip||(t.priority+=++t.retries),t.retries<=t.maxRetries&&f(t),u(),App.callback.call(this,t.error,arguments)}});e.ajax(r),i=r.url},f=function(t,i){if(!t)return App.log({args:"No url given",me:"Loader"}),this;e.isPlainObject(t)||(t={url:t}),e.isNumeric(i)&&Math.abs(i)<n.length&&(t.priority=i);if(!e.isNumeric(t.priority)||Math.abs(t.priority)>n.length)t.priority=n.length;e.isNumeric(t.retries)||(t.retries=0),e.isNumeric(t.maxRetries)||(t.maxRetries=2);if(s(t.url))return App.log({args:["Url %s is already loading",t.url],me:"Loader"}),this;var u=o(t.url);if(!~u)n.splice(t.priority,1,t),App.log({args:["Url %s has been insert at %s",t.url,t.priority],me:"Loader"});else{var f=n[u];f.priority!=t.priority&&(n.splice(u,1),n.splice(t.priority,1,t)),App.log({args:["Url %s was shifted from %s to %s",t.url,f.priority,t.priority],me:"Loader"})}return r||(r=!0,a(),App.log({args:"Load worker has been started",me:"Loader"})),this};window.Loader=e.extend(window.Loader,{load:f,isLoading:s,inQueue:o,working:function(){return r}})}(jQuery),function(e,t){"use strict";var n="body",r=null,i=null,s=function(t,n){return e.isFunction(t)?t.apply(this,n):null},o=!1,u=function(e){return e===!0||e===!1?(o=e,this):e==="!"?(o=!o,this):o},a=[],f=function(t){if(o){if(!t)return this;!!t.args&&!e.isArray(t.args)&&(t.args=[t.args]);var n={args:t.args||arguments,fx:t.fx||"warn",me:t.me||"App"},r=e.type(n.args[0]);if(r==="string"||r==="number"||r=="boolean")n.args[0]="["+n.me+"] "+n.args[0];!console||(e.isFunction(console[n.fx])||(n.fx="log"),console[n.fx].apply?console[n.fx].apply(console,n.args):e.each(n.args,function(t,r){console[n.fx](r)})),a.push(n)}return this},l={},c=function(){var t=function(){return!0},n=function(){return"abstract"},r=function(){return!!e(this.key()).length},i=function(e){s(e)};return{actions:e.noop,key:n,loaded:r,init:e.noop,enter:i,leave:i,canEnter:t,canLeave:t,routes:e.noop}},h=function(t){return e.extend(c(),t)},p=function(e,t,n){var r=h(t);return!!l[e]&&!n?f({args:["Overwriting page key %s is not allowed",e],fx:"error"}):l[e]=r,r},d=function(t,n){var r=-1,i=function(e){return r=e,!1};return!!t&&!!n&&e.each(n,function(r){var s,o=this,u=e.type(o);if(u=="regexp"){if(o.test(t))return i(r)}else if(u=="string"){t=decodeURIComponent(t),t=t.split("#")[0];if(o==t)return i(r);o.indexOf("^")!==0&&(o="^"+o),o.indexOf("^")!==o.length-1&&(o+="$"),o.indexOf("*")&&(o=o.replace(new RegExp("\\*","g"),"[a-zA-Z0-9_/\\-=?&\\[\\]\\\\]*"));try{s=new RegExp(o)}catch(a){f({args:["Error while creating RegExp %s.\n%s",o,a],fx:"error"})}if(!!s&&s.test(t))return i(r)}else if(o===t)return i(r);return!0}),r},v=function(t){var n=null;return N(t)&&e.each(l,function(){var r=this.routes();return~d(t,r)?(n=this,!1):!0}),n},m={},g=function(){return{actions:e.noop,init:e.noop}},y=function(t){return e.extend(g(),t)},b=function(e,t,n){var r=y(t);return!!l[e]&&!n?f({args:["Overwriting module key %s is not allowed",e],fx:"error"}):m[e]=r,r},w=!1,E=document.location.pathname,S=function(t,n,r,i){if(!!t){var o=t[n];if(!e.isFunction(o)&&!!~n.indexOf(".")){o=t;var u=n.split(".");e.each(u,function(){o=o[this];if(!e.isPlainObject(o))return!1})}s(o,[n,r,i])}},x=function(e,t,n){return!r||S(r.actions(),e,t,n),this},T=function(t,n,r){return e.each(m,function(){S(this.actions(),t,n,r)}),this},N=function(e){var t=!1;return e?t=!0:f({args:"No route set.",fx:"error"}),t},C=function(){return w&&f({args:"Mediator is busy waiting for a page load.",fx:"error"}),!w},k=function(e){var t=!0;return e||(t=!1),t},L=function(e){var t=!0;return e.canEnter()||(f("Cannot enter page %s.",e.key()),t=!1),t},A=function(){var e=!1;return r?r.canLeave()?e=!0:f("Cannot leave page %s.",r.key()):f({args:"No current page set.",fx:"error"}),e},O=function(e,t,n){return x(e,t,n),T(e,t,n),this},M=function(t){var s,o="",u=function(){var t=r;T("page.leaving",{page:t}),r.leave(function(){e(t.key()).hide(),i=t,t=null,T("page.leave",{page:i})}),r=null,T("page.entering",{page:s,route:o}),s.enter(function(){r=s,T("page.enter",{page:s,route:o}),w=!1})},a=function(t,r,i){var o=e(t).find(s.key());if(!o.length)f({args:['Could not find "%s" in xhr data.',s.key()],fx:"error"});else{var a=e(n);a.append(o.css({opacity:0})),s.init(),o.hide(),T("pages.loaded",{elem:a}),u()}};return e.type(t)==="string"?A()&&C()&&(s=v(t),o=t):s=t,k(s)?L(s)&&(s===r&&E===o?(f("next page is the current one"),T("pages.navigateToCurrent",{page:s,route:o})):(w=!0,s.loaded()?u():(T("pages.loading"),Loader.load({url:t,priority:0,vip:!0,success:a,error:function(){T("pages.loaderror")}})))):f({args:['Route "%s" was not found.',t],fx:"error"}),this},_=function(e){if(!!r&&C()){var t=v(e);k(t)&&L(t)&&(t!==r?M(e):M(i))}return this},D=function(t){!!t&&!!e(t).length&&(n=t),e.each(m,function(){this.init()}),e.each(l,function(){!this.loaded()||(this.init(),!~d(E,this.routes())||(r=this,i=this,T("page.entering",{page:r,route:E}),r.enter(function(){T("page.enter",{page:r,route:E})})))})},P=function(e){return D(e),this};window.App=e.extend(window.App,{root:function(){return n},callback:s,debug:u,run:P,log:f,logs:function(){return a},mediator:{notify:O,"goto":M,toggle:_},pages:{_matchRoute:d,getPageForRoute:v,page:function(e){return e[0]=="/"?v(e):l[e]},create:h,"export":p,notify:x},modules:{create:y,"export":b,notify:T}})}(jQuery);